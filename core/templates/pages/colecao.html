<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Laboratório de Biologia - Coleção Interativa</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <link href="https://unpkg.com/vis-network/styles/vis-network.min.css" rel="stylesheet" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }

    body {
      background: #f9faff;
      color: #222;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      font-size: 16px;
      line-height: 1.5;
      padding: 20px;
    }

    header {
      background: linear-gradient(90deg, #3a86ff, #8338ec);
      color: white;
      padding: 16px 32px;
      font-weight: 700;
      font-size: 1.6rem;
      border-radius: 12px;
      text-align: center;
      margin-bottom: 24px;
    }

    h2 {
      margin-bottom: 16px;
      font-weight: 700;
      color: #3600b3;
      padding-bottom: 8px;
      border-bottom: 2px solid #f0ebff;
    }

    input[type="file"] {
      margin-bottom: 16px;
      padding: 10px;
      border-radius: 8px;
      border: 2px solid #8338ec;
      background: #f0ebff;
      font-weight: 600;
      width: 100%;
      max-width: 400px;
    }

    .sendbutton {
      background: linear-gradient(90deg, #3a86ff, #8338ec);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 24px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-bottom: 24px;
      background: white;
    }

    th,
    td {
      padding: 10px 12px;
      border: 1px solid #e0e0e0;
      text-align: left;
    }

    thead tr {
      background: linear-gradient(90deg, #8338ec, #3a86ff);
      color: white;
    }

    tbody tr:nth-child(even) {
      background: #f9faff;
    }

    .chart-container {
      background: white;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    canvas {
      width: 100% !important;
      height: 300px !important;
    }

    #network,
    #hierarchyChart {
      width: 100%;
      height: 400px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      background: white;
    }

    .pagination {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 20px 0;
    }

    .pagination-button {
      padding: 8px 16px;
      background: #3a86ff;
      color: white;
      border-radius: 4px;
      text-decoration: none;
      font-weight: 500;
    }

    .pagination-button.disabled {
      background: #e0e0e0;
      color: #9e9e9e;
    }

    .page-info {
      padding: 8px 12px;
    }

    @media (max-width: 768px) {
      .chart-container {
        padding: 12px;
      }

      canvas {
        height: 250px !important;
      }

      #network,
      #hierarchyChart {
        height: 300px;
      }
    }
  </style>
</head>

<body>
  <header>Laboratório de Biologia - Coleção Interativa</header>

  <main>
    <h2>Carregar Planilha Excel (.xlsx)</h2>
    <form method="post" enctype="multipart/form-data" action="{% url 'upload_colecao' %}">
      {% csrf_token %}
      <input type="file" id="upload" name="arquivo_excel" accept=".xlsx,.xls" />
      <button type="submit" class="sendbutton">Enviar Arquivo</button>
    </form>

    <div class="pagination">
      {% if page_obj.has_previous %}
      <a href="?page={{ page_obj.previous_page_number }}" class="pagination-button">Anterior</a>
      {% else %}
      <span class="pagination-button disabled">Anterior</span>
      {% endif %}

      <span class="page-info">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>

      {% if page_obj.has_next %}
      <a href="?page={{ page_obj.next_page_number }}" class="pagination-button">Próxima</a>
      {% else %}
      <span class="pagination-button disabled">Próxima</span>
      {% endif %}
    </div>

    <table>
      <thead>
        <tr>
          <th>Gênero</th>
          <th>Espécie</th>
          <th>Local de Coleta</th>
          <th>Data</th>
        </tr>
      </thead>
      <tbody>
        {% for item in page_obj %}
        <tr>
          <td>{{ item.genero }}</td>
          <td>{{ item.epiteto }}</td>
          <td>{{ item.local}}</td>
          <td>{{ item.data}}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="chart-container">
      <h2>Top 10 Espécies</h2>
      <canvas id="speciesChart"></canvas>
    </div>

    <div class="chart-container">
      <h2>Hierarquia Gênero → Espécie</h2>
      <div id="hierarchyChart"></div>
    </div>

    <div class="chart-container">
      <h2>Relação Espécie-Local (Amostra)</h2>
      <div id="network"></div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>

  <script>
    const allData = JSON.parse('{{ dados_json|escapejs }}');

    function countOccurrences(key) {
      const counts = {};
      allData.forEach(item => {
        const value = item[key] || 'Desconhecido';
        counts[value] = (counts[value] || 0) + 1;
      });
      return Object.entries(counts).sort((a, b) => b[1] - a[1]);
    }

    function createSpeciesChart() {
      const topSpecies = countOccurrences('Espécie').slice(0, 10);
      const ctx = document.getElementById('speciesChart').getContext('2d');

      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: topSpecies.map(item => item[0]),
          datasets: [{
            label: 'Quantidade',
            data: topSpecies.map(item => item[1]),
            backgroundColor: '#8338ec',
            borderColor: '#3600b3',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: { precision: 0 }
            }
          },
          plugins: {
            legend: { display: false }
          }
        }
      });
    }

    function createHierarchyChart() {
      // Amostra de dados para o gráfico hierárquico
      const sampleSize = Math.min(100, allData.length);
      const sampleData = allData.length > 100 ?
        allData.filter((_, i) => i % Math.floor(allData.length / sampleSize) === 0) :
        [...allData];

      const nodes = new vis.DataSet();
      const edges = new vis.DataSet();
      const genera = new Set();
      let id = 1;

      const genusMap = new Map();
      sampleData.forEach(item => {
        const genus = item['Gênero'] || 'Desconhecido';
        const species = item['Espécie'] || 'Desconhecida';

        if (!genusMap.has(genus)) {
          genusMap.set(genus, new Set());
        }
        genusMap.get(genus).add(species);
      });

      genusMap.forEach((speciesSet, genus) => {
        nodes.add({
          id: id,
          label: genus,
          level: 1,
          color: '#3a86ff',
          font: { size: 14, face: 'Poppins', color: '#fff' },
          shape: 'box'
        });
        const genusId = id;
        id++;

        speciesSet.forEach(species => {
          nodes.add({
            id: id,
            label: species,
            level: 2,
            color: '#8338ec',
            font: { size: 12, face: 'Poppins' },
            shape: 'ellipse'
          });
          edges.add({
            from: genusId,
            to: id,
            color: '#888'
          });
          id++;
        });
      });

      const options = {
        layout: {
          hierarchical: {
            direction: 'UD',
            sortMethod: 'directed',
            nodeSpacing: 150,
            levelSeparation: 100
          }
        },
        nodes: {
          shapeProperties: {
            useBorderWithImage: true
          },
          margin: 10,
          size: 20
        },
        edges: {
          smooth: {
            type: 'curvedCW',
            roundness: 0.2
          },
          arrows: {
            to: {
              enabled: true,
              scaleFactor: 0.5
            }
          }
        },
        physics: {
          enabled: false,
          hierarchicalRepulsion: {
            nodeDistance: 150
          }
        },
        interaction: {
          dragNodes: true,
          zoomView: true,
          dragView: true
        }
      };

      const container = document.getElementById('hierarchyChart');
      new vis.Network(container, { nodes, edges }, options);
    }

    function createNetwork() {
      const sampleData = allData.length > 50 ?
        allData.filter((_, i) => i % Math.floor(allData.length / 50) === 0) :
        [...allData];

      const nodes = new vis.DataSet();
      const edges = new vis.DataSet();
      const addedNodes = new Set();
      let id = 1;

      sampleData.forEach(item => {
        const especie = item['Espécie'] || 'Espécie Desconhecida';
        const local = item['Local de Coleta'] || 'Local Desconhecido';

        if (!addedNodes.has(especie)) {
          nodes.add({
            id: id,
            label: especie.length > 20 ? especie.substring(0, 17) + '...' : especie,
            group: 'species',
            color: '#8338ec'
          });
          addedNodes.add(especie);
          id++;
        }

        if (!addedNodes.has(local)) {
          nodes.add({
            id: id,
            label: local.length > 20 ? local.substring(0, 17) + '...' : local,
            group: 'location',
            color: '#3a86ff'
          });
          addedNodes.add(local);
          id++;
        }

        edges.add({
          from: Array.from(addedNodes).indexOf(especie) + 1,
          to: Array.from(addedNodes).indexOf(local) + 1,
          arrows: 'to',
          color: '#888'
        });
      });

      const options = {
        nodes: {
          shape: 'box',
          margin: 10,
          font: {
            size: 12,
            face: 'Poppins'
          }
        },
        edges: {
          width: 1,
          smooth: {
            type: 'continuous'
          }
        },
        physics: {
          enabled: true,
          solver: 'repulsion',
          repulsion: {
            nodeDistance: 150
          }
        },
        interaction: {
          zoomView: true,
          dragView: true
        }
      };

      const container = document.getElementById('network');
      new vis.Network(container, { nodes, edges }, options);
    }
    document.addEventListener('DOMContentLoaded', function () {
      createSpeciesChart();
      createHierarchyChart();

      setTimeout(createNetwork, 500);
    });
  </script>
</body>

</html>